/**
 * @license
 * Copyright Google Inc. All Rights Reserved.
 *
 * Use of this source code is governed by an MIT-style license that can be
 * found in the LICENSE file at https://angular.io/license
 */
import { WrappedNodeExpr, compileNgModule as compileR3NgModule, jitExpression } from '@angular/compiler';
import { flatten } from '../util';
import { angularCoreEnv } from './environment';
var EMPTY_ARRAY = [];
export function compileNgModule(type, ngModule) {
    var meta = {
        type: wrap(type),
        bootstrap: flatten(ngModule.bootstrap || EMPTY_ARRAY).map(wrap),
        declarations: flatten(ngModule.declarations || EMPTY_ARRAY).map(wrap),
        imports: flatten(ngModule.imports || EMPTY_ARRAY).map(expandModuleWithProviders).map(wrap),
        exports: flatten(ngModule.exports || EMPTY_ARRAY).map(expandModuleWithProviders).map(wrap),
        emitInline: true,
    };
    // Compute transitiveCompileScope
    var transitiveCompileScope = {
        directives: new Set(),
        pipes: new Set(),
        modules: new Set(),
    };
    function addExportsFrom(module) {
        if (!transitiveCompileScope.modules.has(module)) {
            module.ngModuleDef.exports.forEach(function (exp) {
                if (isNgModule(exp)) {
                    addExportsFrom(exp);
                }
                else if (exp.ngPipeDef) {
                    transitiveCompileScope.pipes.add(exp);
                }
                else {
                    transitiveCompileScope.directives.add(exp);
                }
            });
        }
    }
    flatten([
        (ngModule.imports || EMPTY_ARRAY), (ngModule.exports || EMPTY_ARRAY)
    ]).forEach(function (importExport) {
        var maybeModule = expandModuleWithProviders(importExport);
        if (isNgModule(maybeModule)) {
            addExportsFrom(maybeModule);
        }
    });
    flatten(ngModule.declarations || EMPTY_ARRAY).forEach(function (decl) {
        if (decl.ngPipeDef) {
            transitiveCompileScope.pipes.add(decl);
        }
        else if (decl.ngDirectiveDef) {
            transitiveCompileScope.directives.add(decl);
        }
        else if (decl.ngComponentDef) {
            transitiveCompileScope.directives.add(decl);
            patchComponentWithScope(decl, type);
        }
        else {
            // A component that has not been compiled yet because the template is being fetched
            // we need to store a reference to the module to update the selector scope after
            // the component gets compiled
            transitiveCompileScope.directives.add(decl);
            decl.ngSelectorScope = type;
        }
    });
    var def = null;
    Object.defineProperty(type, 'ngModuleDef', {
        get: function () {
            if (def === null) {
                var meta_1 = {
                    type: wrap(type),
                    bootstrap: flatten(ngModule.bootstrap || EMPTY_ARRAY).map(wrap),
                    declarations: flatten(ngModule.declarations || EMPTY_ARRAY).map(wrap),
                    imports: flatten(ngModule.imports || EMPTY_ARRAY).map(expandModuleWithProviders).map(wrap),
                    exports: flatten(ngModule.exports || EMPTY_ARRAY).map(expandModuleWithProviders).map(wrap),
                    emitInline: true,
                };
                var res = compileR3NgModule(meta_1);
                def = jitExpression(res.expression, angularCoreEnv, "ng://" + type.name + "/ngModuleDef.js");
                def.transitiveCompileScope = {
                    directives: Array.from(transitiveCompileScope.directives),
                    pipes: Array.from(transitiveCompileScope.pipes),
                };
            }
            return def;
        },
    });
}
export function patchComponentWithScope(component, module) {
    component.ngComponentDef.directiveDefs = function () {
        return module.ngModuleDef.transitiveCompileScope.directives
            .map(function (dir) { return dir.ngDirectiveDef || dir.ngComponentDef; })
            .filter(function (def) { return !!def; });
    };
    component.ngComponentDef.pipeDefs = function () {
        return module.ngModuleDef.transitiveCompileScope.pipes.map(function (pipe) { return pipe.ngPipeDef; });
    };
}
function expandModuleWithProviders(value) {
    if (isModuleWithProviders(value)) {
        return value.ngModule;
    }
    return value;
}
function wrap(value) {
    return new WrappedNodeExpr(value);
}
function isModuleWithProviders(value) {
    return value.ngModule !== undefined;
}
function isNgModule(value) {
    return value.ngModuleDef !== undefined;
}

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibW9kdWxlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vcGFja2FnZXMvY29yZS9zcmMvcmVuZGVyMy9qaXQvbW9kdWxlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBOzs7Ozs7R0FNRztBQUVILE9BQU8sRUFBaUMsZUFBZSxFQUFFLGVBQWUsSUFBSSxpQkFBaUIsRUFBRSxhQUFhLEVBQUMsTUFBTSxtQkFBbUIsQ0FBQztBQUt2SSxPQUFPLEVBQUMsT0FBTyxFQUFDLE1BQU0sU0FBUyxDQUFDO0FBRWhDLE9BQU8sRUFBQyxjQUFjLEVBQUMsTUFBTSxlQUFlLENBQUM7QUFFN0MsSUFBTSxXQUFXLEdBQWdCLEVBQUUsQ0FBQztBQUVwQyxNQUFNLDBCQUEwQixJQUFlLEVBQUUsUUFBa0I7SUFDakUsSUFBTSxJQUFJLEdBQXVCO1FBQy9CLElBQUksRUFBRSxJQUFJLENBQUMsSUFBSSxDQUFDO1FBQ2hCLFNBQVMsRUFBRSxPQUFPLENBQUMsUUFBUSxDQUFDLFNBQVMsSUFBSSxXQUFXLENBQUMsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDO1FBQy9ELFlBQVksRUFBRSxPQUFPLENBQUMsUUFBUSxDQUFDLFlBQVksSUFBSSxXQUFXLENBQUMsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDO1FBQ3JFLE9BQU8sRUFBRSxPQUFPLENBQUMsUUFBUSxDQUFDLE9BQU8sSUFBSSxXQUFXLENBQUMsQ0FBQyxHQUFHLENBQUMseUJBQXlCLENBQUMsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDO1FBQzFGLE9BQU8sRUFBRSxPQUFPLENBQUMsUUFBUSxDQUFDLE9BQU8sSUFBSSxXQUFXLENBQUMsQ0FBQyxHQUFHLENBQUMseUJBQXlCLENBQUMsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDO1FBQzFGLFVBQVUsRUFBRSxJQUFJO0tBQ2pCLENBQUM7SUFFRixpQ0FBaUM7SUFDakMsSUFBTSxzQkFBc0IsR0FBRztR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UyxFQUFkLENBQWMsQ0FBQztJQUE3RSxDQUE2RSxDQUFDO0FBQ3BGLENBQUM7QUFFRCxtQ0FBbUMsS0FBcUM7SUFDdEUsSUFBSSxxQkFBcUIsQ0FBQyxLQUFLLENBQUMsRUFBRTtRQUNoQyxPQUFPLEtBQUssQ0FBQyxRQUFRLENBQUM7S0FDdkI7SUFDRCxPQUFPLEtBQUssQ0FBQztBQUNmLENBQUM7QUFFRCxjQUFjLEtBQWdCO0lBQzVCLE9BQU8sSUFBSSxlQUFlLENBQUMsS0FBSyxDQUFDLENBQUM7QUFDcEMsQ0FBQztBQUVELCtCQUErQixLQUFVO0lBQ3ZDLE9BQU8sS0FBSyxDQUFDLFFBQVEsS0FBSyxTQUFTLENBQUM7QUFDdEMsQ0FBQztBQUVELG9CQUFvQixLQUFVO0lBQzVCLE9BQU8sS0FBSyxDQUFDLFdBQVcsS0FBSyxTQUFTLENBQUM7QUFDekMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQGxpY2Vuc2VcbiAqIENvcHlyaWdodCBHb29nbGUgSW5jLiBBbGwgUmlnaHRzIFJlc2VydmVkLlxuICpcbiAqIFVzZSBvZiB0aGlzIHNvdXJjZSBjb2RlIGlzIGdvdmVybmVkIGJ5IGFuIE1JVC1zdHlsZSBsaWNlbnNlIHRoYXQgY2FuIGJlXG4gKiBmb3VuZCBpbiB0aGUgTElDRU5TRSBmaWxlIGF0IGh0dHBzOi8vYW5ndWxhci5pby9saWNlbnNlXG4gKi9cblxuaW1wb3J0IHtFeHByZXNzaW9uLCBSM05nTW9kdWxlTWV0YWRhdGEsIFdyYXBwZWROb2RlRXhwciwgY29tcGlsZU5nTW9kdWxlIGFzIGNvbXBpbGVSM05nTW9kdWxlLCBqaXRFeHByZXNzaW9ufSBmcm9tICdAYW5ndWxhci9jb21waWxlcic7XG5cbmltcG9ydCB7TW9kdWxlV2l0aFByb3ZpZGVycywgTmdNb2R1bGUsIE5nTW9kdWxlRGVmfSBmcm9tICcuLi8uLi9tZXRhZGF0YS9uZ19tb2R1bGUnO1xuaW1wb3J0IHtUeXBlfSBmcm9tICcuLi8uLi90eXBlJztcbmltcG9ydCB7Q29tcG9uZW50RGVmfSBmcm9tICcuLi9pbnRlcmZhY2VzL2RlZmluaXRpb24nO1xuaW1wb3J0IHtmbGF0dGVufSBmcm9tICcuLi91dGlsJztcblxuaW1wb3J0IHthbmd1bGFyQ29yZUVudn0gZnJvbSAnLi9lbnZpcm9ubWVudCc7XG5cbmNvbnN0IEVNUFRZX0FSUkFZOiBUeXBlPGFueT5bXSA9IFtdO1xuXG5leHBvcnQgZnVuY3Rpb24gY29tcGlsZU5nTW9kdWxlKHR5cGU6IFR5cGU8YW55PiwgbmdNb2R1bGU6IE5nTW9kdWxlKTogdm9pZCB7XG4gIGNvbnN0IG1ldGE6IFIzTmdNb2R1bGVNZXRhZGF0YSA9IHtcbiAgICB0eXBlOiB3cmFwKHR5cGUpLFxuICAgIGJvb3RzdHJhcDogZmxhdHRlbihuZ01vZHVsZS5ib290c3RyYXAgfHwgRU1QVFlfQVJSQVkpLm1hcCh3cmFwKSxcbiAgICBkZWNsYXJhdGlvbnM6IGZsYXR0ZW4obmdNb2R1bGUuZGVjbGFyYXRpb25zIHx8IEVNUFRZX0FSUkFZKS5tYXAod3JhcCksXG4gICAgaW1wb3J0czogZmxhdHRlbihuZ01vZHVsZS5pbXBvcnRzIHx8IEVNUFRZX0FSUkFZKS5tYXAoZXhwYW5kTW9kdWxlV2l0aFByb3ZpZGVycykubWFwKHdyYXApLFxuICAgIGV4cG9ydHM6IGZsYXR0ZW4obmdNb2R1bGUuZXhwb3J0cyB8fCBFTVBUWV9BUlJBWSkubWFwKGV4cGFuZE1vZHVsZVdpdGhQcm92aWRlcnMpLm1hcCh3cmFwKSxcbiAgICBlbWl0SW5saW5lOiB0cnVlLFxuICB9O1xuXG4gIC8vIENvbXB1dGUgdHJhbnNpdGl2ZUNvbXBpbGVTY29wZVxuICBjb25zdCB0cmFuc2l0aXZlQ29tcGlsZVNjb3BlID0ge1xuICAgIGRpcmVjdGl2ZXM6IG5ldyBTZXQ8YW55PigpLFxuICAgIHBpcGVzOiBuZXcgU2V0PGFueT4oKSxcbiAgICBtb2R1bGVzOiBuZXcgU2V0PGFueT4oKSxcbiAgfTtcblxuICBmdW5jdGlvbiBhZGRFeHBvcnRzRnJvbShtb2R1bGU6IFR5cGU8YW55PiYge25nTW9kdWxlRGVmOiBOZ01vZHVsZURlZjxhbnk+fSk6IHZvaWQge1xuICAgIGlmICghdHJhbnNpdGl2ZUNvbXBpbGVTY29wZS5tb2R1bGVzLmhhcyhtb2R1bGUpKSB7XG4gICAgICBtb2R1bGUubmdNb2R1bGVEZWYuZXhwb3J0cy5mb3JFYWNoKChleHA6IGFueSkgPT4ge1xuICAgICAgICBpZiAoaXNOZ01vZHVsZShleHApKSB7XG4gICAgICAgICAgYWRkRXhwb3J0c0Zyb20oZXhwKTtcbiAgICAgICAgfSBlbHNlIGlmIChleHAubmdQaXBlRGVmKSB7XG4gICAgICAgICAgdHJhbnNpdGl2ZUNvbXBpbGVTY29wZS5waXBlcy5hZGQoZXhwKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICB0cmFuc2l0aXZlQ29tcGlsZVNjb3BlLmRpcmVjdGl2ZXMuYWRkKGV4cCk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH1cbiAgfVxuXG4gIGZsYXR0ZW4oW1xuICAgIChuZ01vZHVsZS5pbXBvcnRzIHx8IEVNUFRZX0FSUkFZKSwgKG5nTW9kdWxlLmV4cG9ydHMgfHwgRU1QVFlfQVJSQVkpXG4gIF0pLmZvckVhY2goaW1wb3J0RXhwb3J0ID0+IHtcbiAgICBjb25zdCBtYXliZU1vZHVsZSA9IGV4cGFuZE1vZHVsZVdpdGhQcm92aWRlcnMoaW1wb3J0RXhwb3J0KTtcbiAgICBpZiAoaXNOZ01vZHVsZShtYXliZU1vZHVsZSkpIHtcbiAgICAgIGFkZEV4cG9ydHNGcm9tKG1heWJlTW9kdWxlKTtcbiAgICB9XG4gIH0pO1xuXG4gIGZsYXR0ZW4obmdNb2R1bGUuZGVjbGFyYXRpb25zIHx8IEVNUFRZX0FSUkFZKS5mb3JFYWNoKGRlY2wgPT4ge1xuICAgIGlmIChkZWNsLm5nUGlwZURlZikge1xuICAgICAgdHJhbnNpdGl2ZUNvbXBpbGVTY29wZS5waXBlcy5hZGQoZGVjbCk7XG4gICAgfSBlbHNlIGlmIChkZWNsLm5nRGlyZWN0aXZlRGVmKSB7XG4gICAgICB0cmFuc2l0aXZlQ29tcGlsZVNjb3BlLmRpcmVjdGl2ZXMuYWRkKGRlY2wpO1xuICAgIH0gZWxzZSBpZiAoZGVjbC5uZ0NvbXBvbmVudERlZikge1xuICAgICAgdHJhbnNpdGl2ZUNvbXBpbGVTY29wZS5kaXJlY3RpdmVzLmFkZChkZWNsKTtcbiAgICAgIHBhdGNoQ29tcG9uZW50V2l0aFNjb3BlKGRlY2wsIHR5cGUgYXMgYW55KTtcbiAgICB9IGVsc2Uge1xuICAgICAgLy8gQSBjb21wb25lbnQgdGhhdCBoYXMgbm90IGJlZW4gY29tcGlsZWQgeWV0IGJlY2F1c2UgdGhlIHRlbXBsYXRlIGlzIGJlaW5nIGZldGNoZWRcbiAgICAgIC8vIHdlIG5lZWQgdG8gc3RvcmUgYSByZWZlcmVuY2UgdG8gdGhlIG1vZHVsZSB0byB1cGRhdGUgdGhlIHNlbGVjdG9yIHNjb3BlIGFmdGVyXG4gICAgICAvLyB0aGUgY29tcG9uZW50IGdldHMgY29tcGlsZWRcbiAgICAgIHRyYW5zaXRpdmVDb21waWxlU2NvcGUuZGlyZWN0aXZlcy5hZGQoZGVjbCk7XG4gICAgICBkZWNsLm5nU2VsZWN0b3JTY29wZSA9IHR5cGU7XG4gICAgfVxuICB9KTtcblxuICBsZXQgZGVmOiBhbnkgPSBudWxsO1xuICBPYmplY3QuZGVmaW5lUHJvcGVydHkodHlwZSwgJ25nTW9kdWxlRGVmJywge1xuICAgIGdldDogKCkgPT4ge1xuICAgICAgaWYgKGRlZiA9PT0gbnVsbCkge1xuICAgICAgICBjb25zdCBtZXRhOiBSM05nTW9kdWxlTWV0YWRhdGEgPSB7XG4gICAgICAgICAgdHlwZTogd3JhcCh0eXBlKSxcbiAgICAgICAgICBib290c3RyYXA6IGZsYXR0ZW4obmdNb2R1bGUuYm9vdHN0cmFwIHx8IEVNUFRZX0FSUkFZKS5tYXAod3JhcCksXG4gICAgICAgICAgZGVjbGFyYXRpb25zOiBmbGF0dGVuKG5nTW9kdWxlLmRlY2xhcmF0aW9ucyB8fCBFTVBUWV9BUlJBWSkubWFwKHdyYXApLFxuICAgICAgICAgIGltcG9ydHM6XG4gICAgICAgICAgICAgIGZsYXR0ZW4obmdNb2R1bGUuaW1wb3J0cyB8fCBFTVBUWV9BUlJBWSkubWFwKGV4cGFuZE1vZHVsZVdpdGhQcm92aWRlcnMpLm1hcCh3cmFwKSxcbiAgICAgICAgICBleHBvcnRzOlxuICAgICAgICAgICAgICBmbGF0dGVuKG5nTW9kdWxlLmV4cG9ydHMgfHwgRU1QVFlfQVJSQVkpLm1hcChleHBhbmRNb2R1bGVXaXRoUHJvdmlkZXJzKS5tYXAod3JhcCksXG4gICAgICAgICAgZW1pdElubGluZTogdHJ1ZSxcbiAgICAgICAgfTtcbiAgICAgICAgY29uc3QgcmVzID0gY29tcGlsZVIzTmdNb2R1bGUobWV0YSk7XG4gICAgICAgIGRlZiA9IGppdEV4cHJlc3Npb24ocmVzLmV4cHJlc3Npb24sIGFuZ3VsYXJDb3JlRW52LCBgbmc6Ly8ke3R5cGUubmFtZX0vbmdNb2R1bGVEZWYuanNgKTtcbiAgICAgICAgZGVmLnRyYW5zaXRpdmVDb21waWxlU2NvcGUgPSB7XG4gICAgICAgICAgZGlyZWN0aXZlczogQXJyYXkuZnJvbSh0cmFuc2l0aXZlQ29tcGlsZVNjb3BlLmRpcmVjdGl2ZXMpLFxuICAgICAgICAgIHBpcGVzOiBBcnJheS5mcm9tKHRyYW5zaXRpdmVDb21waWxlU2NvcGUucGlwZXMpLFxuICAgICAgICB9O1xuICAgICAgfVxuICAgICAgcmV0dXJuIGRlZjtcbiAgICB9LFxuICB9KTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHBhdGNoQ29tcG9uZW50V2l0aFNjb3BlPEMsIE0+KFxuICAgIGNvbXBvbmVudDogVHlwZTxDPiYge25nQ29tcG9uZW50RGVmOiBDb21wb25lbnREZWY8Qz59LFxuICAgIG1vZHVsZTogVHlwZTxNPiYge25nTW9kdWxlRGVmOiBOZ01vZHVsZURlZjxNPn0pIHtcbiAgY29tcG9uZW50Lm5nQ29tcG9uZW50RGVmLmRpcmVjdGl2ZURlZnMgPSAoKSA9PlxuICAgICAgbW9kdWxlLm5nTW9kdWxlRGVmLnRyYW5zaXRpdmVDb21waWxlU2NvcGUgIS5kaXJlY3RpdmVzXG4gICAgICAgICAgLm1hcChkaXIgPT4gZGlyLm5nRGlyZWN0aXZlRGVmIHx8IGRpci5uZ0NvbXBvbmVudERlZilcbiAgICAgICAgICAuZmlsdGVyKGRlZiA9PiAhIWRlZik7XG4gIGNvbXBvbmVudC5uZ0NvbXBvbmVudERlZi5waXBlRGVmcyA9ICgpID0+XG4gICAgICBtb2R1bGUubmdNb2R1bGVEZWYudHJhbnNpdGl2ZUNvbXBpbGVTY29wZSAhLnBpcGVzLm1hcChwaXBlID0+IHBpcGUubmdQaXBlRGVmKTtcbn1cblxuZnVuY3Rpb24gZXhwYW5kTW9kdWxlV2l0aFByb3ZpZGVycyh2YWx1ZTogVHlwZTxhbnk+fCBNb2R1bGVXaXRoUHJvdmlkZXJzKTogVHlwZTxhbnk+IHtcbiAgaWYgKGlzTW9kdWxlV2l0aFByb3ZpZGVycyh2YWx1ZSkpIHtcbiAgICByZXR1cm4gdmFsdWUubmdNb2R1bGU7XG4gIH1cbiAgcmV0dXJuIHZhbHVlO1xufVxuXG5mdW5jdGlvbiB3cmFwKHZhbHVlOiBUeXBlPGFueT4pOiBFeHByZXNzaW9uIHtcbiAgcmV0dXJuIG5ldyBXcmFwcGVkTm9kZUV4cHIodmFsdWUpO1xufVxuXG5mdW5jdGlvbiBpc01vZHVsZVdpdGhQcm92aWRlcnModmFsdWU6IGFueSk6IHZhbHVlIGlzIE1vZHVsZVdpdGhQcm92aWRlcnMge1xuICByZXR1cm4gdmFsdWUubmdNb2R1bGUgIT09IHVuZGVmaW5lZDtcbn1cblxuZnVuY3Rpb24gaXNOZ01vZHVsZSh2YWx1ZTogYW55KTogdmFsdWUgaXMgVHlwZTxhbnk+JntuZ01vZHVsZURlZjogTmdNb2R1bGVEZWY8YW55Pn0ge1xuICByZXR1cm4gdmFsdWUubmdNb2R1bGVEZWYgIT09IHVuZGVmaW5lZDtcbn1cbiJdfQ==